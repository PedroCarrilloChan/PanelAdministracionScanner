<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarjeta de Fidelidad Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stamp-unearned { opacity: 0.3; filter: grayscale(100%); }
        .stamp { transition: all 0.3s ease-in-out; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal { transition: opacity 0.3s ease; }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
        }
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .pulse-glow {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 40px rgba(251, 191, 36, 0.8);
                transform: scale(1.05);
            }
        }

        .success-message {
            animation: success-pop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes success-pop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center p-4 bg-cover bg-center transition-all duration-500">

    <div id="loading-screen" class="w-full max-w-sm mx-auto text-center text-white">
        <div class="spinner mx-auto"></div>
        <p id="loading-message" class="mt-4">Cargando configuraci√≥n del negocio...</p>
    </div>

    <div id="login-screen" class="w-full max-w-sm mx-auto transition-opacity duration-500 ease-in-out hidden">
        <div class="glass-card rounded-3xl shadow-2xl text-white p-8 text-center">
            <h2 class="text-2xl font-bold mb-2">Acceso de Personal</h2>
            <p class="text-gray-300 mb-6">Introduce tu PIN de 4 d√≠gitos</p>
            <div id="pin-inputs" class="flex justify-center gap-3 sm:gap-4 mb-4">
                <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input w-12 h-14 sm:w-14 sm:h-16 text-3xl text-center bg-white/10 rounded-xl focus:ring-2 focus:outline-none">
                <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input w-12 h-14 sm:w-14 sm:h-16 text-3xl text-center bg-white/10 rounded-xl focus:ring-2 focus:outline-none">
                <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input w-12 h-14 sm:w-14 sm:h-16 text-3xl text-center bg-white/10 rounded-xl focus:ring-2 focus:outline-none">
                <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input w-12 h-14 sm:w-14 sm:h-16 text-3xl text-center bg-white/10 rounded-xl focus:ring-2 focus:outline-none">
            </div>
            <p id="login-error" class="text-red-400 h-5"></p>
        </div>
    </div>

    <main id="main-content" class="w-full max-w-sm mx-auto hidden transition-opacity duration-500 ease-in-out opacity-0">
        <div id="loyalty-card" class="glass-card rounded-3xl shadow-2xl text-white overflow-hidden p-6 md:p-8 relative">
            <div id="initial-loading" class="absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-20">
                <div class="spinner"></div>
                <p id="initial-loading-message" class="mt-4 text-white">Verificando cliente...</p>
            </div>
            <div class="flex justify-between items-center mb-6">
                <h1 id="card-title" class="text-xl sm:text-2xl font-bold text-gray-100 whitespace-nowrap">Estampillas</h1>
                <span id="points-counter" class="text-lg font-bold ml-3"></span>
            </div>
            <div id="stamps-grid" class="grid gap-4 mb-6"></div>
            <div class="mb-6">
                <p id="name-label" class="text-sm">Nombre:</p>
                <p id="customer-name" class="text-2xl sm:text-3xl font-bold text-gray-50"></p>
            </div>
            <div class="flex flex-col items-center">
                <div class="bg-white p-2 rounded-lg">
                    <img id="qr-code-img" src="" alt="C√≥digo QR" class="w-28 h-28 sm:w-36 sm:h-36">
                </div>
                <p id="pid-number" class="mt-3 text-base sm:text-lg font-mono tracking-widest text-gray-300"></p>
            </div>
            <div class="absolute bottom-4 right-4 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
        </div>
        <div class="mt-8 flex items-stretch justify-center gap-2">
            <input type="number" id="custom-points-input" placeholder="Cant." class="w-20 text-center bg-white/10 text-white border border-white/20 rounded-xl focus:ring-2 focus:outline-none">
            <button id="add-custom-points-btn" class="text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105">A√±adir</button>
        </div>
        <div class="flex justify-center gap-4 mt-4">
            <button id="add-point-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105">A√±adir 1 Punto</button>
            <button id="remove-point-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105">Quitar 1 Punto</button>
        </div>
    </main>

    <!-- Modales -->
    <div id="notification-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg p-6 shadow-xl text-center">
            <p id="notification-message" class="text-gray-800"></p>
        </div>
    </div>
    <div id="loading-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 opacity-0 pointer-events-none">
        <div class="glass-card rounded-2xl p-8">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Modal de Redenci√≥n de Oferta -->
    <div id="redeem-offer-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="text-center">
            <div class="mb-6">
                <svg class="w-24 h-24 mx-auto text-yellow-400 mb-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                <h3 class="text-3xl font-bold text-yellow-400 mb-2">¬°Oferta Disponible!</h3>
                <p class="text-white text-lg">Presiona el bot√≥n para canjear</p>
            </div>
            <button id="redeem-offer-btn" class="pulse-glow bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-gray-900 font-bold py-4 px-12 rounded-2xl shadow-2xl text-xl transition-all transform hover:scale-110">
                üéÅ Canjear Oferta
            </button>
        </div>
    </div>

    <!-- Modal de √âxito -->
    <div id="success-modal" class="modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div id="success-content" class="text-center success-message">
            <div class="text-8xl mb-6">üéâ</div>
            <h2 class="text-4xl font-bold text-yellow-400 mb-4">¬°Felicidades!</h2>
            <p class="text-white text-2xl">Oferta canjeada con √©xito</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_saB4ac0Vks7fmnuAeqEohsh64F2P1Rw",
            authDomain: "bd-paginas-scaner-smartpasses.firebaseapp.com",
            projectId: "bd-paginas-scaner-smartpasses",
            storageBucket: "bd-paginas-scaner-smartpasses.firebasestorage.app",
            messagingSenderId: "481910580797",
            appId: "1:481910580797:web:7782eadb69dab794b26c54"
        };
        const appId = 'smart-passes-loyalty-app'; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let businessConfig = {};
        let customersPromise;
        let customerId = null;
        let currentStamps = 0;
        let totalStamps = 8;
        let hasAvailableOffers = false;

        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const pinInputsContainer = document.getElementById('pin-inputs');
        const pinInputs = [...pinInputsContainer.querySelectorAll('.pin-input')];
        const loginError = document.getElementById('login-error');
        const stampsGrid = document.getElementById('stamps-grid');
        const addPointBtn = document.getElementById('add-point-btn');
        const removePointBtn = document.getElementById('remove-point-btn');
        const customerNameEl = document.getElementById('customer-name');
        const pidNumberEl = document.getElementById('pid-number');
        const qrCodeImgEl = document.getElementById('qr-code-img');
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const loadingModal = document.getElementById('loading-modal');
        const initialLoadingEl = document.getElementById('initial-loading');
        const initialLoadingMessageEl = document.getElementById('initial-loading-message');
        const pointsCounterEl = document.getElementById('points-counter');
        const customPointsInput = document.getElementById('custom-points-input');
        const addCustomPointsBtn = document.getElementById('add-custom-points-btn');
        const nameLabel = document.getElementById('name-label');
        const cardTitleEl = document.getElementById('card-title');
        const redeemOfferModal = document.getElementById('redeem-offer-modal');
        const redeemOfferBtn = document.getElementById('redeem-offer-btn');
        const successModal = document.getElementById('success-modal');

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const businessId = urlParams.get('businessId');

            if (!businessId) {
                loadingMessage.textContent = "Error: Falta el ID del negocio en la URL.";
                return;
            }

            try {
                await signInAnonymously(auth);
                const businessDocRef = doc(db, `/artifacts/${appId}/public/data/businesses`, businessId);
                const businessDocSnap = await getDoc(businessDocRef);

                if (!businessDocSnap.exists()) {
                    throw new Error("El negocio especificado no existe.");
                }
                businessConfig = businessDocSnap.data();
                totalStamps = businessConfig.totalStamps || 8;

                applyTheme(businessConfig);
                customersPromise = prefetchCustomers(businessConfig.apiKey, businessConfig.programId);

                loadingScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                pinInputs[0].focus();

            } catch (error) {
                loadingMessage.textContent = `Error: ${error.message}`;
                console.error(error);
            }
        });

        function applyTheme(config) {
            const theme = config.theme;
            document.body.style.backgroundImage = `url('${theme.backgroundImageUrl || 'https://images.unsplash.com/photo-1550547660-d9450f859349?q=80&w=1965&auto=format&fit=crop'}')`;
            pointsCounterEl.style.color = theme.accentColor;
            nameLabel.style.color = theme.accentColor;
            cardTitleEl.textContent = config.cardTitle || 'Estampillas';
            addCustomPointsBtn.style.backgroundColor = theme.buttonColor;
            pinInputs.forEach(input => input.style.setProperty('--tw-ring-color', theme.buttonColor));
            customPointsInput.style.setProperty('--tw-ring-color', theme.buttonColor);
        }

        function prefetchCustomers(apiKey, programId) {
            const urlParams = new URLSearchParams(window.location.search);
            const emailToFind = urlParams.get('email');
            if (!emailToFind) {
                return Promise.reject(new Error('Falta el email del cliente en la URL.'));
            }
            const customersApiUrl = `https://pass.smartpasses.io/api/v1/loyalty/programs/${programId}/customers`;
            return fetch(customersApiUrl, {
                headers: { 'Content-Type': 'application/json', 'Authorization': apiKey }
            }).then(response => {
                if (!response.ok) throw new Error('No se pudo obtener la lista de clientes.');
                return response.json();
            });
        }

        function checkPin() {
            const enteredPin = pinInputs.map(input => input.value).join('');
            if (enteredPin.length === 4) {
                if (enteredPin === businessConfig.staffPin) {
                    loginScreen.classList.add('opacity-0');
                    loginScreen.addEventListener('transitionend', () => {
                        loginScreen.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        setTimeout(() => mainContent.classList.remove('opacity-0'), 50);
                        setupCustomerView();
                    }, { once: true });
                } else {
                    loginError.textContent = 'PIN Incorrecto';
                    pinInputsContainer.classList.add('shake');
                    pinInputs.forEach(input => input.value = '');
                    setTimeout(() => {
                        pinInputsContainer.classList.remove('shake');
                        loginError.textContent = '';
                    }, 1000);
                    pinInputs[0].focus();
                }
            }
        }

        async function setupCustomerView() {
            const urlParams = new URLSearchParams(window.location.search);
            const emailToFind = urlParams.get('email');
            const firstName = urlParams.get('firstName') || 'Cliente';
            const lastName = urlParams.get('lastName') || 'Ejemplo';
            const pidNumber = urlParams.get('pidNumber') || '0000000000000';
            currentStamps = parseInt(urlParams.get('points'), 10) || 0;

            customerNameEl.textContent = `${firstName} ${lastName}`;
            pidNumberEl.textContent = pidNumber.replace(/(\d{4})(\d{4})(\d{4})(\d{1})/, '$1 $2 $3 $4');
            qrCodeImgEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${pidNumber}`;

            try {
                const customersData = await customersPromise;
                const customers = customersData.data || customersData;
                const foundCustomer = customers.find(c => c.email.toLowerCase() === emailToFind.toLowerCase());

                if (foundCustomer) {
                    customerId = foundCustomer.id;
                    await checkAvailableOffers();
                    initialLoadingEl.classList.add('opacity-0', 'pointer-events-none');
                    renderUI();
                } else {
                    initialLoadingMessageEl.textContent = `Error: No se encontr√≥ cliente con el email ${emailToFind}.`;
                }
            } catch (error) {
                initialLoadingMessageEl.textContent = `Error: ${error.message}`;
            }
        }

        async function checkAvailableOffers() {
            if (!customerId) return;
            
            const customerApiUrl = `https://pass.smartpasses.io/api/v1/loyalty/programs/${businessConfig.programId}/customers/${customerId}`;
            
            try {
                const response = await fetch(customerApiUrl, {
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': businessConfig.apiKey 
                    }
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    const customerData = responseData.data || responseData;
                    
                    hasAvailableOffers = Boolean(customerData?.currentOfferId);
                    
                    if (hasAvailableOffers) {
                        console.log(`Oferta disponible: ${customerData.currentOfferName || 'Sin nombre'}`);
                    }
                } else {
                    hasAvailableOffers = false;
                    console.error("Error en la respuesta del API:", response.status);
                }
            } catch (error) {
                console.error("Error al consultar ofertas:", error);
                hasAvailableOffers = false;
            }
        }

        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#fd79a8', '#fdcb6e'];
            const confettiCount = 100;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3500);
            }
        }

        async function redeemOffer() {
            if (!customerId) {
                showNotification('Error: No se ha podido identificar al cliente.');
                return;
            }
            
            const redeemApiUrl = `https://pass.smartpasses.io/api/v1/loyalty/programs/${businessConfig.programId}/customers/${customerId}/offers/current/redeem`;
            
            redeemOfferModal.classList.add('opacity-0', 'pointer-events-none');
            loadingModal.classList.remove('opacity-0', 'pointer-events-none');
            
            redeemOfferBtn.disabled = true;
            [addPointBtn, removePointBtn, addCustomPointsBtn].forEach(btn => btn.disabled = true);
            
            try {
                const response = await fetch(redeemApiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': businessConfig.apiKey 
                    },
                    body: JSON.stringify({ confirm: true })
                });
                
                if (response.status === 202 || response.ok) {
                    loadingModal.classList.add('opacity-0', 'pointer-events-none');
                    
                    createConfetti();
                    
                    const successContent = document.getElementById('success-content');
                    successContent.classList.remove('success-message');
                    void successContent.offsetWidth;
                    successContent.classList.add('success-message');
                    
                    successModal.classList.remove('opacity-0', 'pointer-events-none');
                    
                    hasAvailableOffers = false;
                    renderUI();
                    
                    await sendMessageToCustomer('üéÅ ¬°Felicidades! Tu oferta ha sido canjeada con √©xito.');
                    
                    setTimeout(() => {
                        successModal.classList.add('opacity-0', 'pointer-events-none');
                    }, 4000);
                    
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Error desconocido' }));
                    throw new Error(errorData.message || 'No se pudo redimir la oferta');
                }
            } catch (error) {
                loadingModal.classList.add('opacity-0', 'pointer-events-none');
                showNotification(`Error: ${error.message}`);
                redeemOfferModal.classList.remove('opacity-0', 'pointer-events-none');
            } finally {
                redeemOfferBtn.disabled = false;
                [addPointBtn, removePointBtn, addCustomPointsBtn].forEach(btn => btn.disabled = false);
                renderUI();
            }
        }

        function renderUI() {
            pointsCounterEl.textContent = `${currentStamps}/${totalStamps}`;

            stampsGrid.classList.remove('grid-cols-4', 'grid-cols-5', 'grid-cols-6');
            if (totalStamps === 10) {
                stampsGrid.classList.add('grid-cols-5');
            } else if (totalStamps === 12) {
                stampsGrid.classList.add('grid-cols-6');
            } else {
                stampsGrid.classList.add('grid-cols-4');
            }

            stampsGrid.innerHTML = ''; 
            const iconSvg = businessConfig.theme.iconSvg || '<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C16.9706 2 21 6.02944 21 11V12H3V11C3 6.02944 7.02944 2 12 2Z" fill="#FBBF24"></path></svg>';
            for (let i = 0; i < totalStamps; i++) {
                const stampEl = document.createElement('div');
                stampEl.classList.add('stamp');
                stampEl.innerHTML = iconSvg;
                if (i >= currentStamps) stampEl.classList.add('stamp-unearned');
                stampsGrid.appendChild(stampEl);
            }
            addPointBtn.disabled = currentStamps >= totalStamps;
            addCustomPointsBtn.disabled = currentStamps >= totalStamps;
            removePointBtn.disabled = currentStamps <= 0;

            if (hasAvailableOffers) {
                redeemOfferModal.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                redeemOfferModal.classList.add('opacity-0', 'pointer-events-none');
            }
        };

        async function updatePointsOnServer(pointsToChange) {
            if (!customerId) {
                showNotification('Error: No se ha podido identificar al cliente.');
                return false;
            }
            const apiUrl = `https://pass.smartpasses.io/api/v1/loyalty/programs/${businessConfig.programId}/customers/${customerId}/points/add`;
            loadingModal.classList.remove('opacity-0', 'pointer-events-none');
            [addPointBtn, removePointBtn, addCustomPointsBtn].forEach(btn => btn.disabled = true);
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': businessConfig.apiKey },
                    body: JSON.stringify({ points: pointsToChange })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Error desconocido' }));
                    throw new Error(errorData.message);
                }
                return true;
            } catch (error) {
                showNotification(`Error: ${error.message}`);
                return false;
            } finally {
                loadingModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        async function sendMessageToCustomer(message) {
             const messageApiUrl = `https://pass.smartpasses.io/api/v1/loyalty/programs/${businessConfig.programId}/customers/${customerId}/message`;
            try {
                await fetch(messageApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': businessConfig.apiKey },
                    body: JSON.stringify({ message })
                });
            } catch (error) { console.error("Error en la API de mensajes:", error); }
        }

        pinInputsContainer.addEventListener('input', (e) => {
            const target = e.target;
            if (target.value !== '' && target.nextElementSibling) {
                target.nextElementSibling.focus();
            }
            checkPin();
        });
        pinInputsContainer.addEventListener('keyup', (e) => {
            if ((e.key === 'Backspace' || e.key === 'Delete') && e.target.previousElementSibling) {
                e.target.previousElementSibling.focus();
            }
        });

        addPointBtn.addEventListener('click', async () => {
            if (currentStamps < totalStamps) {
                const success = await updatePointsOnServer(1);
                if (success) {
                    currentStamps++;
                    renderUI();
                    showNotification('¬°Punto a√±adido con √©xito!');
                    await sendMessageToCustomer(`‚úÖ Se a√±adi√≥ 1 punto con Exito`);
                } else { renderUI(); }
            }
        });

        removePointBtn.addEventListener('click', async () => {
            if (currentStamps > 0) {
                const success = await updatePointsOnServer(-1);
                if (success) {
                    currentStamps--;
                    renderUI();
                    showNotification('Punto eliminado con √©xito.');
                    await sendMessageToCustomer(`‚ùå Se ha eliminado 1 punto de tu tarjeta.`);
                } else { renderUI(); }
            }
        });

        addCustomPointsBtn.addEventListener('click', async () => {
            const pointsToAdd = parseInt(customPointsInput.value, 10);
            if (isNaN(pointsToAdd) || pointsToAdd <= 0) {
                showNotification('Por favor, introduce un n√∫mero v√°lido.');
                return;
            }
            if (currentStamps + pointsToAdd > totalStamps) {
                showNotification(`No se pueden a√±adir ${pointsToAdd} puntos. El m√°ximo es ${totalStamps}.`);
                return;
            }
            const success = await updatePointsOnServer(pointsToAdd);
            if (success) {
                currentStamps += pointsToAdd;
                renderUI();
                const message = pointsToAdd === 1 ? `‚úÖ Se a√±adi√≥ 1 punto con Exito` : `‚úÖ Se a√±adieron ${pointsToAdd} puntos con Exito`;
                showNotification(`¬°${pointsToAdd} puntos a√±adidos con √©xito!`);
                await sendMessageToCustomer(message);
                customPointsInput.value = '';
            } else {
                renderUI();
            }
        });

        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                notificationModal.classList.add('opacity-0', 'pointer-events-none');
            }, 2500);
        };

        redeemOfferBtn.addEventListener('click', async () => {
            await redeemOffer();
        });
    </script>
</body>
</html>
